
starting the test for backup

DROP DATABASE IF EXISTS bup_db1;
DROP DATABASE IF EXISTS bup_db2;
CREATE DATABASE bup_db1;
USE bup_db1;
Creating Table t1
CREATE TABLE bup_db1.t1(
id INT NOT NULL PRIMARY KEY, 
name CHAR(10),
city VARCHAR(10)
)ENGINE=INNODB;
loading data
INSERT INTO bup_db1.t1 VALUES
(1,'aa1','RR1'),(2,'aa2','RR2'),(3,'aa3','RR3'),(4,'aa4','RR4'),
(5,'aa5','RR5'),(6,'aa6','RR6'),(7,'aa7','RR7'),(8,'aa8','RR8');
SELECT * FROM bup_db1.t1 ORDER BY id;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
Creating Table t3
CREATE TABLE bup_db1.t3(
ccode INT, 
District CHAR(20) NOT NULL PRIMARY KEY, 
scode INT, 
FOREIGN KEY (scode) REFERENCES bup_db1.t1(id)
)ENGINE=INNODB;
Loading Data
INSERT INTO t3 VALUES
(234, 'zuloa',1),(321,'yyy',2),(765,'iug',3),
(124,'LKJ',4),(235,'uth',6);
SELECT * FROM bup_db1.t3 ORDER BY scode;
ccode	District	scode
234	zuloa	1
321	yyy	2
765	iug	3
124	LKJ	4
235	uth	6
*****Create view from the table bup_db1.t1*******
CREATE VIEW bup_db1.v1 AS SELECT * FROM bup_db1.t1;
***Create views from 2 tables(t1 and t3) within same DB bup_db1****
CREATE VIEW bup_db1.vcomb AS 
SELECT name, city, ccode FROM bup_db1.t1, bup_db1.t3 WHERE id=scode;
CREATE DATABASE bup_db2;
CREATE TABLE bup_db2.t2(
idno INT, 
age INT PRIMARY KEY, 
education CHAR(20) ,
FOREIGN KEY (idno) REFERENCES bup_db1.t1(id)
)ENGINE=INNODB;
INSERT INTO bup_db2.t2 VALUES
(1,23,'BS'),(2,24,'BE'),(3,19,'School'),(4,28,'MS'),
(5,43,'PHD'),(6,30,'Doctor'),(7,31,'Lawyer'),(8,27,'Undergrad');
SELECT * FROM bup_db2.t2 ORDER BY age;
idno	age	education
3	19	School
1	23	BS
2	24	BE
8	27	Undergrad
4	28	MS
6	30	Doctor
7	31	Lawyer
5	43	PHD
****Create view in bup_db2****
CREATE VIEW bup_db2.v2 AS SELECT age, education FROM bup_db2.t2;
******Create views from combination of 2 databases*******
CREATE VIEW bup_db2.v3 AS SELECT name, age, education 
FROM bup_db1.t1 , bup_db2.t2 WHERE id=idno;
*********Create view from another view in bup_db2***********.
CREATE VIEW bup_db2.vv (N, A, E) AS SELECT * FROM bup_db2.v3;
*****Create view from other Database********
CREATE VIEW bup_db2.v4 AS SELECT * FROM bup_db1.t3;
Rename the view name
RENAME TABLE bup_db2.v4 to bup_db2.student_details;
*******Create view from database bup_db2**********
CREATE VIEW bup_db1.v5 AS SELECT * FROM bup_db2.t2;
Creating Table t5
CREATE TABLE bup_db1.t5(
Gender CHAR(5),
cand_age INT,
FOREIGN KEY(cand_age) REFERENCES bup_db2.t2(age)
)ENGINE=INNODB;
Loading data into table t5
INSERT INTO bup_db1.t5 VALUES
('F',23),('F',24),('M',19),('F',28),
('M',43),('F',30),('M',31),('M',27);
SELECT * FROM bup_db1.t5 ORDER BY Gender;
Gender	cand_age
F	23
F	24
F	28
F	30
M	19
M	43
M	31
M	27
******Create view v6********
CREATE VIEW bup_db1.v6 AS SELECT education,gender 
FROM bup_db2.v2, bup_db1.t5  WHERE cand_age=age;
SELECT * FROM bup_db1.t1 ORDER BY id;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db1.t3 ORDER BY scode;
ccode	District	scode
234	zuloa	1
321	yyy	2
765	iug	3
124	LKJ	4
235	uth	6
SELECT * FROM bup_db1.t5 ORDER BY Gender;
Gender	cand_age
F	23
F	24
F	28
F	30
M	19
M	43
M	31
M	27
SELECT * FROM bup_db1.v1;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db1.vcomb ORDER BY name;
name	city	ccode
aa1	RR1	234
aa2	RR2	321
aa3	RR3	765
aa4	RR4	124
aa6	RR6	235
SELECT * FROM bup_db1.v5 ORDER BY age;
idno	age	education
3	19	School
1	23	BS
2	24	BE
8	27	Undergrad
4	28	MS
6	30	Doctor
7	31	Lawyer
5	43	PHD
SELECT * FROM bup_db1.v6 ORDER BY gender;
education	gender
MS	F
Doctor	F
BS	F
BE	F
Undergrad	M
Lawyer	M
PHD	M
School	M
excercise objects of bup_db2
SELECT * FROM bup_db2.t2 ORDER BY age;
idno	age	education
3	19	School
1	23	BS
2	24	BE
8	27	Undergrad
4	28	MS
6	30	Doctor
7	31	Lawyer
5	43	PHD
SELECT * FROM bup_db2.v2 ORDER BY age;
age	education
19	School
23	BS
24	BE
27	Undergrad
28	MS
30	Doctor
31	Lawyer
43	PHD
SELECT * FROM bup_db2.v3 ORDER BY age;
name	age	education
aa3	19	School
aa1	23	BS
aa2	24	BE
aa8	27	Undergrad
aa4	28	MS
aa6	30	Doctor
aa7	31	Lawyer
aa5	43	PHD
SELECT * FROM bup_db2.vv;
N	A	E
aa1	23	BS
aa2	24	BE
aa3	19	School
aa4	28	MS
aa5	43	PHD
aa6	30	Doctor
aa7	31	Lawyer
aa8	27	Undergrad
SELECT * FROM bup_db2.student_details;
ccode	District	scode
765	iug	3
124	LKJ	4
235	uth	6
321	yyy	2
234	zuloa	1
showing objects and create statements.
SHOW FULL TABLES FROM bup_db1;;
Tables_in_bup_db1	t1
Table_type	BASE TABLE
Tables_in_bup_db1	t3
Table_type	BASE TABLE
Tables_in_bup_db1	t5
Table_type	BASE TABLE
Tables_in_bup_db1	v1
Table_type	VIEW
Tables_in_bup_db1	v5
Table_type	VIEW
Tables_in_bup_db1	v6
Table_type	VIEW
Tables_in_bup_db1	vcomb
Table_type	VIEW
SHOW FULL TABLES FROM bup_db2;;
Tables_in_bup_db2	student_details
Table_type	VIEW
Tables_in_bup_db2	t2
Table_type	BASE TABLE
Tables_in_bup_db2	v2
Table_type	VIEW
Tables_in_bup_db2	v3
Table_type	VIEW
Tables_in_bup_db2	vv
Table_type	VIEW
SHOW CREATE VIEW bup_db1.v1;;
View	v1
Create View	CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `v1` AS select `t1`.`id` AS `id`,`t1`.`name` AS `name`,`t1`.`city` AS `city` from `t1`
character_set_client	latin1
collation_connection	latin1_swedish_ci
SHOW CREATE VIEW bup_db1.vcomb;;
View	vcomb
Create View	CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `vcomb` AS select `t1`.`name` AS `name`,`t1`.`city` AS `city`,`t3`.`ccode` AS `ccode` from (`t1` join `t3`) where (`t1`.`id` = `t3`.`scode`)
character_set_client	latin1
collation_connection	latin1_swedish_ci
SHOW CREATE VIEW bup_db2.v3;;
View	v3
Create View	CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `bup_db2`.`v3` AS select `bup_db1`.`t1`.`name` AS `name`,`bup_db2`.`t2`.`age` AS `age`,`bup_db2`.`t2`.`education` AS `education` from (`bup_db1`.`t1` join `bup_db2`.`t2`) where (`bup_db1`.`t1`.`id` = `bup_db2`.`t2`.`idno`)
character_set_client	latin1
collation_connection	latin1_swedish_ci
backup database
BACKUP DATABASE bup_db1, bup_db2 TO 'bup_objectview.bak';
backup_id
#
BACKUP DATABASE bup_db1 TO 'bup_objectview1.bak';
backup_id
#
BACKUP DATABASE bup_db2 TO 'bup_objectview2.bak';
backup_id
#
dropping  database.
DROP TABLE bup_db1.t3;
DROP TABLE bup_db1.t5;
DROP TABLE bup_db2.t2;
DROP DATABASE bup_db1;
DROP DATABASE bup_db2;
Restore database.
restore database with view dependency to other, non-existing db
RESTORE FROM 'bup_objectview1.bak';
ERROR 42S02: Table 'bup_db2.t2' doesn't exist
DROP DATABASE bup_db1;
RESTORE FROM 'bup_objectview2.bak';
ERROR 42S02: Table 'bup_db1.t3' doesn't exist
DROP DATABASE bup_db2;
RESTORE FROM 'bup_objectview.bak';
backup_id
#
showing objects and create statements
SHOW CREATE DATABASE bup_db1;;
Database	bup_db1
Create Database	CREATE DATABASE `bup_db1` /*!40100 DEFAULT CHARACTER SET latin1 */
SHOW FULL TABLES FROM bup_db1;;
Tables_in_bup_db1	t1
Table_type	BASE TABLE
Tables_in_bup_db1	t3
Table_type	BASE TABLE
Tables_in_bup_db1	t5
Table_type	BASE TABLE
Tables_in_bup_db1	v1
Table_type	VIEW
Tables_in_bup_db1	v5
Table_type	VIEW
Tables_in_bup_db1	v6
Table_type	VIEW
Tables_in_bup_db1	vcomb
Table_type	VIEW
SHOW FULL TABLES FROM bup_db2;;
Tables_in_bup_db2	student_details
Table_type	VIEW
Tables_in_bup_db2	t2
Table_type	BASE TABLE
Tables_in_bup_db2	v2
Table_type	VIEW
Tables_in_bup_db2	v3
Table_type	VIEW
Tables_in_bup_db2	vv
Table_type	VIEW
SHOW CREATE VIEW bup_db1.v1;;
View	v1
Create View	CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `bup_db1`.`v1` AS select `bup_db1`.`t1`.`id` AS `id`,`bup_db1`.`t1`.`name` AS `name`,`bup_db1`.`t1`.`city` AS `city` from `bup_db1`.`t1`
character_set_client	latin1
collation_connection	latin1_swedish_ci
SHOW CREATE VIEW bup_db1.vcomb;;
View	vcomb
Create View	CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `bup_db1`.`vcomb` AS select `bup_db1`.`t1`.`name` AS `name`,`bup_db1`.`t1`.`city` AS `city`,`bup_db1`.`t3`.`ccode` AS `ccode` from (`bup_db1`.`t1` join `bup_db1`.`t3`) where (`bup_db1`.`t1`.`id` = `bup_db1`.`t3`.`scode`)
character_set_client	latin1
collation_connection	latin1_swedish_ci
SHOW CREATE VIEW bup_db2.v3;;
View	v3
Create View	CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `bup_db2`.`v3` AS select `bup_db1`.`t1`.`name` AS `name`,`bup_db2`.`t2`.`age` AS `age`,`bup_db2`.`t2`.`education` AS `education` from (`bup_db1`.`t1` join `bup_db2`.`t2`) where (`bup_db1`.`t1`.`id` = `bup_db2`.`t2`.`idno`)
character_set_client	latin1
collation_connection	latin1_swedish_ci
****check for view contents after Restore*****
SELECT * FROM bup_db1.t1 ORDER BY id;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db1.t3 ORDER BY scode;
ccode	District	scode
234	zuloa	1
321	yyy	2
765	iug	3
124	LKJ	4
235	uth	6
SELECT * FROM bup_db1.t5 ORDER BY Gender;
Gender	cand_age
F	23
F	24
F	28
F	30
M	19
M	43
M	31
M	27
SELECT * FROM bup_db1.v1;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db1.vcomb ORDER BY name;
name	city	ccode
aa1	RR1	234
aa2	RR2	321
aa3	RR3	765
aa4	RR4	124
aa6	RR6	235
SELECT * FROM bup_db1.v5 ORDER BY age;
idno	age	education
3	19	School
1	23	BS
2	24	BE
8	27	Undergrad
4	28	MS
6	30	Doctor
7	31	Lawyer
5	43	PHD
SELECT * FROM bup_db1.v6 ORDER BY gender;
education	gender
Doctor	F
BS	F
BE	F
MS	F
Lawyer	M
PHD	M
School	M
Undergrad	M
excercise objects of bup_db2
SELECT * FROM bup_db2.t2 ORDER BY age;
idno	age	education
3	19	School
1	23	BS
2	24	BE
8	27	Undergrad
4	28	MS
6	30	Doctor
7	31	Lawyer
5	43	PHD
SELECT * FROM bup_db2.v2 ORDER BY age;
age	education
19	School
23	BS
24	BE
27	Undergrad
28	MS
30	Doctor
31	Lawyer
43	PHD
SELECT * FROM bup_db2.v3 ORDER BY age;
name	age	education
aa3	19	School
aa1	23	BS
aa2	24	BE
aa8	27	Undergrad
aa4	28	MS
aa6	30	Doctor
aa7	31	Lawyer
aa5	43	PHD
SELECT * FROM bup_db2.vv;
N	A	E
aa1	23	BS
aa2	24	BE
aa3	19	School
aa4	28	MS
aa5	43	PHD
aa6	30	Doctor
aa7	31	Lawyer
aa8	27	Undergrad
SELECT * FROM bup_db2.student_details;
ccode	District	scode
765	iug	3
124	LKJ	4
235	uth	6
321	yyy	2
234	zuloa	1
ALTER TABLE bup_db1.t1 CHANGE name name VARCHAR(10);
DESCRIBE bup_db1.t1;
Field	Type	Null	Key	Default	Extra
id	int(11)	NO	PRI	NULL	
name	varchar(10)	YES		NULL	
city	varchar(10)	YES		NULL	
SELECT * FROM bup_db1.t1 ORDER BY id;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db1.v1;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db2.v3 ORDER BY age;
name	age	education
aa3	19	School
aa1	23	BS
aa2	24	BE
aa8	27	Undergrad
aa4	28	MS
aa6	30	Doctor
aa7	31	Lawyer
aa5	43	PHD
BACKUP DATABASE bup_db1, bup_db2 TO 'bup_objectview3.bak';
backup_id
#
DROP TABLE bup_db1.t3;
DROP TABLE bup_db1.t5;
DROP TABLE bup_db2.t2;
DROP DATABASE bup_db1;
DROP DATABASE bup_db2;
RESTORE FROM 'bup_objectview3.bak';
backup_id
#
SELECT * FROM bup_db2.v3 ORDER BY age;
name	age	education
aa3	19	School
aa1	23	BS
aa2	24	BE
aa8	27	Undergrad
aa4	28	MS
aa6	30	Doctor
aa7	31	Lawyer
aa5	43	PHD
SELECT * FROM bup_db1.t1 ORDER BY id;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8

*** ENTER Backup of database with missing view dependency 
*** should fail but not crash server 
*** Test for bug#34902 ***
initializing test
DROP TABLE bup_db1.t3;
DROP TABLE bup_db1.t5;
DROP TABLE bup_db2.t2;
DROP DATABASE bup_db1;
DROP DATABASE bup_db2;
RESTORE FROM 'bup_objectview.bak';
backup_id
#
SELECT * FROM bup_db1.t1;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
SELECT * FROM bup_db1.v1;
id	name	city
1	aa1	RR1
2	aa2	RR2
3	aa3	RR3
4	aa4	RR4
5	aa5	RR5
6	aa6	RR6
7	aa7	RR7
8	aa8	RR8
DROP TABLE bup_db1.t3;
DROP TABLE bup_db1.t5;
DROP TABLE bup_db2.t2;
DROP TABLE bup_db1.t1;

Testing backup with missing view dependency in same db

SELECT * FROM bup_db1.v1;
ERROR HY000: View 'bup_db1.v1' references invalid table(s) or column(s) or function(s) or definer/invoker of view lack rights to use them
BACKUP DATABASE bup_db1 TO 'bup_shouldfail1.bak';
ERROR HY000: Failed to add view `bup_db1`.`v1` to the catalog

Testing backup with missing view dependency in other db

USE bup_db2;
SELECT * from bup_db2.v3;
ERROR HY000: View 'bup_db2.v3' references invalid table(s) or column(s) or function(s) or definer/invoker of view lack rights to use them
BACKUP DATABASE bup_db2 TO 'bup_shouldfail2.bak';
ERROR HY000: Failed to add view `bup_db2`.`student_details` to the catalog

*** EXIT Backup of database with missing view dependency


***  DROP bup_db1, bup_db2 DATABASE ****

DROP DATABASE bup_db1;
DROP DATABASE bup_db2;
