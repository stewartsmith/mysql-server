--echo #
--echo # MyISAM keycache coverage tests.
--echo #

--source include/have_debug.inc
let $debug= `SELECT @@debug`;

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

CREATE TABLE t1 (c1 VARCHAR(5), c2 int) ENGINE=MyISAM;
CREATE INDEX i1 ON t1 (c1, c2);
INSERT INTO t1 VALUES ('A',1);
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;

--echo #
--echo # Positive tests.
--echo #
SELECT COUNT(*) FROM t1 FORCE INDEX(i1) WHERE c2 < 5;
LOAD INDEX INTO CACHE t1;
UPDATE t1 SET c2=2;

--echo #
--echo # Close table and clear cache.
--echo #
FLUSH TABLE t1;

--echo #
--echo # Inject error key_cache_read_block_error
--echo #
SET debug='+d,key_cache_read_block_error';
--replace_regex /'.*[\/\\]/'/
--error 126
SELECT COUNT(*) FROM t1 FORCE INDEX(i1) WHERE c2 < 5;
--echo # Reset debug variable to its original value.
--disable_query_log
eval SET debug= '$debug';
--enable_query_log
FLUSH TABLE t1;

--echo #
--echo # Inject error key_cache_insert_block_error
--echo #
SET debug='+d,key_cache_insert_block_error';
LOAD INDEX INTO CACHE t1;
--echo # Reset debug variable to its original value.
--disable_query_log
eval SET debug= '$debug';
--enable_query_log
FLUSH TABLE t1;

--echo #
--echo # Inject error key_cache_write_block_error
--echo #
SET debug='+d,key_cache_write_block_error';
--replace_regex /'.*[\/\\]/'/
--error 126
UPDATE t1 SET c2=1;
--echo # Reset debug variable to its original value.
--disable_query_log
eval SET debug= '$debug';
--enable_query_log
FLUSH TABLE t1;

--echo #
--echo # Cleanup
--echo #
DROP TABLE t1;

