# Test to verify that auto-zerofilling happens when a table is
# restored from a different Maria instance

# can't restart in embedded
--source include/not_embedded.inc
--source include/have_maria.inc

let $MARIA_LOG=.;
let $MYSQLD_BACKUPDIR= `select @@backupdir`;

--disable_warnings
drop database if exists mysqltest;
--error 0,1
remove_file $MYSQLD_BACKUPDIR/test.ba;
--enable_warnings
create database mysqltest;
let $mms_tname=t;

connect (admin, localhost, root,,mysqltest,,);
--enable_reconnect

connection default;
use mysqltest;
--enable_reconnect

create table t1(a int, unique(a)) engine=maria;
insert into t1 values(1);
insert into t1 values(2);
--replace_column 1 #
BACKUP DATABASE mysqltest TO 'test.ba';

# this will remove control file, so change the uuid of the Maria
# instance, thus t1 will appear as imported from elsewhere.

-- source include/maria_empty_logs.inc

--replace_column 1 #
RESTORE FROM 'test.ba' OVERWRITE;
disable_ps_protocol; # see maria-recover.test
replace_regex /Table.*t1/t1/ ;
select * from t1;
enable_ps_protocol;
check table t1 extended;
flush table t1;

# Check that table is auto-zerofilled, movable
--exec $MARIA_CHK -dv $MYSQLD_BACKUPDIR/mysqltest/t1 >$MYSQLTEST_VARDIR/tmp/mariachk.txt
perl;
    use strict;
    use warnings;
    my $fname= "$ENV{'MYSQLTEST_VARDIR'}/tmp/mariachk.txt";
    open(FILE, "<", $fname) or die;
    my @content= <FILE>;
    print grep(/Status:.*zerofilled/, @content);
    print "create_rename_lsn has magic value\n" if grep(/create_rename \(0,0x2\)/, @content);
    close FILE;
EOF

# this will attach t1 to the current Maria instance
insert into t1 values(3);
check table t1 extended;
flush table t1;

# Check that table is not zerofilled, not movable
--exec $MARIA_CHK -dv $MYSQLD_BACKUPDIR/mysqltest/t1 >$MYSQLTEST_VARDIR/tmp/mariachk.txt
perl;
    use strict;
    use warnings;
    my $fname= "$ENV{'MYSQLTEST_VARDIR'}/tmp/mariachk.txt";
    open(FILE, "<", $fname) or die;
    my @content= <FILE>;
    print grep(/Status:.*(zerofilled|movable)/, @content);
    print "create_rename_lsn has non-magic value\n" if grep(/create_rename \([0-9]+/, @content);
    close FILE;
EOF

drop database mysqltest;
remove_file $MYSQLD_BACKUPDIR/test.ba;
