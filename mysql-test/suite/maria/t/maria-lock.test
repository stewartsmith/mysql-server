#
# Different cases involving locking that has failed with Maria
#
# Can't test with embedded server
-- source include/not_embedded.inc

--disable_warnings
drop table if exists t1,t2,t3;
--enable_warnings

# Check that a lock merge works.
create table t1 (c1 int) engine=maria;
create table t2 (c1 int) engine=maria;
create table t3 (c1 int) engine=maria;
lock tables t1 write, t2 write, t3 write, t1 as t4 read;
alter table t2 add column c2 int;
drop table t1, t2, t3;

#
# Bug #39395 maria_extra: Assertion `share->reopen == 1' failed
#
# Test problem when using locks on many tables and droping a table that
# is to-be-locked by another thread. Dropped table locked twice
#

connect (locker,localhost,root,,);
connect (reader,localhost,root,,);
connect (writer,localhost,root,,);

connection locker;
create table t1 (a int) engine=maria;
create table t2 (a int) engine=maria;
lock table t1 write, t2 write, t1 as t1_2 write, t2 as t2_2 write;
connection reader;
send insert t1 select * from t2;
connection locker;
let $wait_condition=
  select count(*) = 1 from information_schema.processlist
  where state = "Table lock" and info = "insert t1 select * from t2";
--source include/wait_condition.inc
drop table t2;
--echo "table dropped";
connection reader;
--error 1146
reap;
connection locker;
drop table t1;
connection default;

#
# We need to disconnect and reconnect for the bug to appear. This is still
# part of Bug#39395
#

disconnect locker;
disconnect reader;
disconnect writer;
connect (locker,localhost,root,,);
connect (reader,localhost,root,,);
connect (writer,localhost,root,,);

connection locker;
create table t1 (a int, b int) engine=maria;
create table t2 (c int, d int) engine=maria;
insert into t1 values(1,1);
insert into t1 values(2,2);
insert into t2 values(1,2);
lock table t1 read;
connection writer;
update t1,t2 set c=a where b=d;
connection reader;
select c from t2;
connection locker;
unlock tables;
drop table t1;
drop table t2;

connection locker;
create table t1 (a int) engine=maria;
create table t2 (a int) engine=maria;
lock table t1 write, t2 write, t1 as t1_2 write, t2 as t2_2 write;
connection reader;
send insert t1 select * from t2;
connection locker;
let $wait_condition=
  select count(*) = 1 from information_schema.processlist
  where state = "Table lock" and info = "insert t1 select * from t2";
--source include/wait_condition.inc
drop table t2;
connection reader;
--error 1146
reap;
connection locker;
drop table t1;
connection default;
disconnect locker;
disconnect reader;
disconnect writer;
