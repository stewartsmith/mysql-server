#
# This test tests the backup using no data engines.
# It was made a separate test due to the possibility that some
# of the engines used may not be available on all platforms or
# builds.
#
# The test creates a database with tables using all of the known
# no data engines. It runs a backup then a restore and compares
# the results.
#
--source include/not_embedded.inc
--source include/have_federated_db.inc
--source include/have_exampledb.inc
--source include/have_blackhole.inc

--disable_warnings
DROP DATABASE IF EXISTS bup_nodata;
DROP DATABASE IF EXISTS bup_data;

let $MYSQLD_DATADIR= `SELECT @@datadir`;
--error 0,1
remove_file $MYSQLD_DATADIR/bup_data.bak;
--error 0,1
remove_file $MYSQLD_DATADIR/bup_nodata.bak;
--enable_warnings

# Create data
--echo Creating tables
CREATE DATABASE bup_nodata;

CREATE DATABASE bup_data;

CREATE TABLE bup_data.myisam1 (a int, b char(30)) ENGINE=MYISAM;

CREATE TABLE bup_data.myisam2 (a int, b char(30)) ENGINE=MYISAM;

CREATE TABLE bup_data.myisam3 (a int, b char(30)) ENGINE=MYISAM;

CREATE TABLE bup_data.f1 (
    `id` int(20) NOT NULL,
    `group` int NOT NULL default 0,
    `batch` InT NOT NULL default 0,
    `qty` int NOT NULL default 0,
    `name` varchar(32) NOT NULL default ''
    )
  DEFAULT CHARSET=latin1;

CREATE TABLE bup_nodata.merge1 (a int, b char(30))
  ENGINE=MERGE UNION=(bup_data.myisam1, bup_data.myisam2, bup_data.myisam3);

--replace_result $MASTER_MYPORT MASTER_PORT
eval CREATE TABLE bup_nodata.f1 (
    `id` int(20) NOT NULL,
    `group` int NOT NULL default 0,
    `batch` InT NOT NULL default 0,
    `qty` int NOT NULL default 0,
    `name` varchar(32) NOT NULL default ''
    )
  ENGINE="FEDERATED" DEFAULT CHARSET=latin1
  CONNECTION='mysql://root@127.0.0.1:$MASTER_MYPORT/bup_data/f1';

CREATE TABLE bup_nodata.b1 (a int, b int, c char(10)) ENGINE=BLACKHOLE;

CREATE TABLE bup_nodata.e1 (
  Period smallint(4) unsigned zerofill DEFAULT '0000' NOT NULL,
  Vapor_period smallint(4) unsigned DEFAULT '0' NOT NULL
) ENGINE=example;

# Insert some data (for merge and federated to ensure proper working tables)
--echo Inserting data
INSERT INTO bup_data.myisam1 VALUES (11, 'table 1');
INSERT INTO bup_data.myisam1 VALUES (12, 'table 1');
INSERT INTO bup_data.myisam1 VALUES (13, 'table 1');
INSERT INTO bup_data.myisam2 VALUES (21, 'table 2');
INSERT INTO bup_data.myisam2 VALUES (22, 'table 2');
INSERT INTO bup_data.myisam2 VALUES (23, 'table 2');
INSERT INTO bup_data.myisam3 VALUES (31, 'table 3');
INSERT INTO bup_data.myisam3 VALUES (32, 'table 3');
INSERT INTO bup_data.myisam3 VALUES (33, 'table 3');

INSERT INTO bup_data.f1 (id, name) VALUES (1, 'foo');
INSERT INTO bup_data.f1 (id, name) VALUES (2, 'fee');
INSERT INTO bup_data.f1 (id, `group`) VALUES (3, 42);
INSERT INTO bup_data.f1 (id, `batch`) VALUES (4, 23);
INSERT INTO bup_data.f1 (id, `qty`) VALUES (5, 1);

# Show the data
--echo show data
SHOW FULL TABLES FROM bup_data;
SHOW FULL TABLES FROM bup_nodata;

SELECT * FROM bup_nodata.merge1;
SELECT * FROM bup_nodata.f1;
SELECT * FROM bup_nodata.b1;
SELECT * FROM bup_nodata.e1;

# Do the backup of the bup_data DB.
--replace_column 1 #
BACKUP DATABASE bup_data TO 'bup_data.bak';

# Do the backup of the bup_nodata DB.
--replace_column 1 #
BACKUP DATABASE bup_nodata TO 'bup_nodata.bak';

# Show the data
--echo show data
SHOW FULL TABLES FROM bup_data;
SHOW FULL TABLES FROM bup_nodata;

SELECT * FROM bup_nodata.merge1;
SELECT * FROM bup_nodata.f1;
SELECT * FROM bup_nodata.b1;
SELECT * FROM bup_nodata.e1;

# Now drop the data database and show what is left

DROP DATABASE bup_data;

# Show the data
--echo show data
SHOW FULL TABLES FROM bup_nodata;

# The merge and federated tables should have errors since data is missing.
--error ER_NO_SUCH_TABLE
SELECT * FROM bup_nodata.merge1;
--error ER_CONNECT_TO_FOREIGN_DATA_SOURCE,ER_QUERY_ON_FOREIGN_DATA_SOURCE
SELECT * FROM bup_nodata.f1;
SELECT * FROM bup_nodata.b1;
SELECT * FROM bup_nodata.e1;

DROP DATABASE bup_nodata;

# Now restore the nodata database and see if it is the same as above.
--echo Restoring nodata database.
--replace_column 1 #
RESTORE FROM 'bup_nodata.bak';

# Show the data
--echo show data
SHOW FULL TABLES FROM bup_nodata;

# The merge and federated tables should have errors since data is missing.
--error ER_NO_SUCH_TABLE
SELECT * FROM bup_nodata.merge1;
--error ER_CONNECT_TO_FOREIGN_DATA_SOURCE,ER_QUERY_ON_FOREIGN_DATA_SOURCE
SELECT * FROM bup_nodata.f1;
SELECT * FROM bup_nodata.b1;
SELECT * FROM bup_nodata.e1;

# Now restore the data database and see that all is well.
--echo Restoring data database.
--replace_column 1 #
RESTORE FROM 'bup_data.bak';

# Show the data
--echo show data
SHOW FULL TABLES FROM bup_data;
SHOW FULL TABLES FROM bup_nodata;

SELECT * FROM bup_nodata.merge1;
SELECT * FROM bup_nodata.f1;
SELECT * FROM bup_nodata.b1;
SELECT * FROM bup_nodata.e1;

DROP DATABASE bup_data;
DROP DATABASE bup_nodata;

remove_file $MYSQLD_DATADIR/bup_data.bak;
remove_file $MYSQLD_DATADIR/bup_nodata.bak;

