#
# Tests with MyISAM native driver.
#

--source include/not_embedded.inc

#
# Precautionary cleanup
#
--disable_warnings
USE test;
DROP DATABASE IF EXISTS mysql_db1;
--error 0,1
--remove_file $MYSQLTEST_VARDIR/master-data/bup_myisam.bak
--enable_warnings

--echo #
--echo # Bug#40944 - Backup: crash after myisampack
--echo #
CREATE DATABASE mysql_db1;
CREATE TABLE mysql_db1.t1 (c1 VARCHAR(5), c2 int);
CREATE INDEX i1 ON mysql_db1.t1 (c1, c2);
INSERT INTO mysql_db1.t1 VALUES ('A',1);
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
INSERT INTO mysql_db1.t1 SELECT * FROM mysql_db1.t1;
FLUSH TABLE mysql_db1.t1;
#
--exec $MYISAMPACK -s $MYSQLTEST_VARDIR/master-data/mysql_db1/t1
--exec $MYISAMCHK -srq $MYSQLTEST_VARDIR/master-data/mysql_db1/t1
#
--replace_column 1 #
BACKUP DATABASE mysql_db1 to 'bup_myisam.bak';
--replace_column 1 #
RESTORE FROM 'bup_myisam.bak' OVERWRITE;
#
SELECT COUNT(*) FROM mysql_db1.t1 WHERE c2 < 5;
#
# Cleanup
#
DROP TABLE mysql_db1.t1;
DROP DATABASE mysql_db1;
--remove_file $MYSQLTEST_VARDIR/master-data/bup_myisam.bak

--echo
--echo #
--echo # Bug#38045 - Backup, MyISAM and file system encoding
--echo #
CREATE DATABASE mysqltest;
USE mysqltest;
CREATE TABLE `äöüß£å` (id SERIAL) ENGINE=MyISAM;
--replace_column 1 #
BACKUP DATABASE mysqltest TO 'bup_myisam.bak';
DROP TABLE `äöüß£å`;
USE test;
DROP DATABASE mysqltest;
--remove_file $MYSQLTEST_VARDIR/master-data/bup_myisam.bak

