--source include/have_falcon.inc
--source include/have_partition.inc

#
# BUG#33404 - Falcon ignores partition-level TABLESPACE option
#
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.fts' ENGINE=Falcon;
CREATE TABLESPACE ts2 ADD DATAFILE 'ts2.fts' ENGINE=Falcon;
CREATE TABLESPACE ts3 ADD DATAFILE 'ts3.fts' ENGINE=Falcon;

CREATE TABLE t1 (a INT) ENGINE=Falcon TABLESPACE ts1
PARTITION BY RANGE(a) SUBPARTITION BY HASH(a) (
  PARTITION p1 VALUES LESS THAN (100) TABLESPACE ts2 (
    SUBPARTITION p1s1 TABLESPACE ts3,
    SUBPARTITION p1s2
  ),
  PARTITION p2 VALUES LESS THAN MAXVALUE (
    SUBPARTITION p2s1,
    SUBPARTITION p2s2
  )
);
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';
SHOW CREATE TABLE t1;

ALTER TABLE t1 REMOVE PARTITIONING;
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';

ALTER TABLE t1 TABLESPACE ts1
PARTITION BY RANGE(a) SUBPARTITION BY HASH(a) (
  PARTITION p1 VALUES LESS THAN (100) TABLESPACE ts2 (
    SUBPARTITION p1s1 TABLESPACE ts3,
    SUBPARTITION p1s2
  ),
  PARTITION p2 VALUES LESS THAN (200) (
    SUBPARTITION p2s1,
    SUBPARTITION p2s2
  )
);
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';

ALTER TABLE t1 ADD PARTITION (PARTITION p3 VALUES LESS THAN MAXVALUE);
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';

ALTER TABLE t1 REORGANIZE PARTITION p3 INTO (PARTITION p3 VALUES LESS THAN
MAXVALUE TABLESPACE ts1);
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';

ALTER TABLE t1 REORGANIZE PARTITION p3 INTO (PARTITION p3 VALUES LESS THAN
MAXVALUE TABLESPACE ts2);
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';

ALTER TABLE t1 REORGANIZE PARTITION p1 INTO (PARTITION p1 VALUES LESS THAN
(100) TABLESPACE ts2);
SELECT * FROM INFORMATION_SCHEMA.FALCON_TABLES WHERE
  TABLE_NAME = 't1' AND SCHEMA_NAME='test';

DROP TABLE t1;
DROP TABLESPACE ts1 ENGINE=Falcon;
DROP TABLESPACE ts2 ENGINE=Falcon;
DROP TABLESPACE ts3 ENGINE=Falcon;
