###########################################################################
# Author: Hema
# Date: 2008-04-11
# Purpose: To test the metadata consistency of views.
###############################################################################
--source include/have_innodb.inc
--source include/not_embedded.inc
--source include/have_debug.inc

connect (backup,localhost,root,,);
connect (breakpoints,localhost,root,,);

##############################################################
--echo
--echo starting the test for backup
--echo
##############################################################


let $MYSQLD_DATADIR= `select @@datadir`;
--error 0,1
remove_file $MYSQLD_DATADIR/bup_objectview.bak;

#Create Database and object view for this test.

--disable_warnings
DROP DATABASE IF EXISTS bup_db1;
DROP DATABASE IF EXISTS bup_db2;


#We are creating 2 databases bup_db1 and bup_db2 to accomplish wide testing of  views in order to check their consistency    #  after BACKUP AND RESTORE.
# In bup_db1 DATABASE consists of tables :t1 t3 t5
# and views v1(based on t1 alone), vcomb(based on t1 and t3), v5( based on bup_db2.t2), v6(based on bup_db2.v2,bup_db1.t5)
#
# In bup_db2,it consists table t2
# views v2(based on t2), v3( based on combination of bup_db1 and bup_db2),v4( based on  bup_db1.t3), vv( based on v3)
#

--enable_warnings

CREATE DATABASE bup_db1;
USE bup_db1;

#Create table and load with data.

--echo Creating Table t1
CREATE TABLE t1(id int not null primary key, name char(10),city varchar(10));

--echo loading data
INSERT INTO t1 VALUES 
(1,'aa1','RR1'),(2,'aa2','RR2'),(3,'aa3','RR3'),(4,'aa4','RR4'),(5,'aa5','RR5'),(6,'aa6','RR6'),(7,'aa7','RR7'),(8,'aa8','RR8');

SELECT * FROM t1;

--echo Creating Table t3

CREATE TABLE t3(ccode int, District char(20) not null primary key, scode int, foreign key (scode) references t1(id));

--echo Loading Data

INSERT INTO t3 VALUES
(234, 'zuloa',1),(321,'yyy',2),(765,'iug',3),(124,'LKJ',4),(235,'uth',6);

SELECT * FROM t3;

--echo Creating Table t5

CREATE TABLE t5(Gender char(5), cand_age int,foreign key(cand_age) references 
bup_db2.t2(age));

--echo Loading data into table t5

INSERT INTO t5 VALUES
('F',23),('F',24),('M',19),('F',28),('M',43),('F',30),('M',31),('M',27);

SELECT * FROM t5;

--echo *****Create views from the table t1 of bup_db1*******

CREATE VIEW v1  AS SELECT * FROM t1;

--echo *****Creating views from 2 tables(t1 and t3) within same database******

CREATE VIEW vcomb AS SELECT name, city, ccode FROM t1, t3 WHERE id=scode;


CREATE DATABASE bup_db2;
USE bup_db2;

CREATE TABLE t2(idno int, age int primary key, education char(20) ,foreign key (idno) references bup_db1.t1(id));

INSERT INTO t2 VALUES(1,23,'BS'),(2,24,'BE'),(3,19,'school'),(4,28,'MS'),(5,43,'PHD'),(6,30,'Doctor'),(7,31,'Lawyer'),(8,27,'undergrad');


SELECT * FROM t2;

--echo ****Creating View****

CREATE VIEW v2 AS SELECT age, education FROM t2;

--echo ******Creating Views from combination of 2 databases*******

CREATE VIEW v3 AS SELECT name, age, education FROM bup_db1.t1 , bup_db2.t2 WHERE id=idno;

--echo *********Creating View from another view ***********.

#Bug#35347 Mysql Server crash while doing restore with views for default  driver
# BUG#34758 Server crashes if database with views backed up using CS driver
#Creatig view from another view is possible if bug#35347 and bug#34758 is fixed.

#CREATE VIEW vv (N, A, E) AS SELECT * FROM v3;

--echo *****Creating View from other Database********

CREATE VIEW v4 AS SELECT * FROM bup_db1.t3;

--echo Rename the view name

RENAME TABLE v4 to student_details;

USE bup_db1;

--echo *******Creating View from database bup_db2**********

CREATE VIEW v5 AS SELECT * FROM bup_db2.t2;

--echo ******Creating View v6********

#Bug#36213 Restore fails for a database that has views created using another database .

#CREATE VIEW v6 AS SELECT education,gender FROM bup_db2.v2, t5  WHERE cand_age=age;

#Excercise the objects of bup_db1

USE bup_db1;

SELECT * FROM t1;

SELECT * FROM t3;

SELECT * FROM t5;

SELECT * FROM v1;

SELECT * FROM vcomb;

SELECT * FROM v5;

#SELECT * FROM v6;

--echo excercise objects of bup_db2

USE bup_db2;

SELECT * FROM t2;

SELECT * FROM v2;

SELECT * FROM v3;

#SELECT * FROM vv;

SELECT * FROM student_details; #view v4 is renamed as student_details

#Show the data and Create statements

--echo showing objects and create statements.
--query_vertical SHOW FULL TABLES FROM bup_db1;
--query_vertical SHOW FULL TABLES FROM bup_db2;
--query_vertical SHOW CREATE VIEW bup_db1.v1;
--query_vertical SHOW CREATE VIEW bup_db1.vcomb;
--query_vertical SHOW CREATE VIEW bup_db2.v3;

#Backup and restore data.
--echo backup data
replace_column 1 #;
BACKUP DATABASE bup_db1, bup_db2 TO 'bup_objectview.bak';

replace_column 1 #;
BACKUP DATABASE bup_db1 TO 'bup_objectview1.bak';

replace_column 1 #;
BACKUP DATABASE bup_db2 TO 'bup_objectview2.bak';

--echo dropping  database.
DROP DATABASE bup_db1;

DROP DATABASE bup_db2;

#RESTORE FROM bup_objectview.bak;

#Individual databases cannot be restored because of VIEW DEPENDENCY

#--error 1146
#RESTORE FROM 'bup_objectview1.bak';
#--error 1146
#RESTORE FROM 'bup_objectview2.bak';

replace_column 1 #;
RESTORE FROM 'bup_objectview.bak';

#show data and create statements
--echo showing objects and create statements
--query_vertical SHOW CREATE DATABASE bup_db1;
--query_vertical SHOW FULL TABLES FROM bup_db1;
--query_vertical SHOW FULL TABLES FROM bup_db2;
--query_vertical SHOW CREATE VIEW bup_db1.v1;
--query_vertical SHOW CREATE VIEW bup_db1.vcomb;
--query_vertical SHOW CREATE VIEW bup_db2.v3;

--echo ****check for view contents after Restore*****

#Excercise the objects of bup_db1
USE bup_db1;
SELECT * FROM t1;

SELECT * FROM t3;

SELECT * FROM t5;

SELECT * FROM v1;

SELECT * FROM vcomb;

SELECT * FROM v5;

#SELECT * FROM v6;
--echo excercise objects of bup_db2
use bup_db2;
SELECT * FROM t2;

SELECT * FROM v2;

SELECT * FROM v3;

#SELECT * FROM vv;

SELECT * FROM student_details;

DROP DATABASE bup_db1;
DROP DATABASE bup_db2;

--echo Restoring Database

replace_column 1 #;
RESTORE FROM 'bup_objectview.bak';

USE bup_db1;

#Alter table t1 and take BACKUP to see if view is not affected.

ALTER TABLE t1 CHANGE id id tinyint not null;
--query_vertical SHOW CREATE TABLE t1;

SELECT * FROM t1;

DELETE FROM t1 WHERE id=7;
SELECT * FROM t1;

SELECT * FROM v1;

USE bup_db2;
SELECT * FROM v3;

#BUG#35249 Mysql server crash for delete operation followed by backup for Default Drivers.

#DELETE FROM t2 WHERE age=24;
#SELECT * FROM t2;
#SELECT * FROM v3;

replace_column 1 #;
BACKUP DATABASE bup_db1, bup_db2 TO 'bup_objectview3.bak';

DROP DATABASE bup_db1;
DROP DATABASE bup_db2;

replace_column 1 #;
RESTORE FROM 'bup_objectview3.bak';

USE bup_db2;
SELECT * FROM v3;

USE bup_db1;
SELECT * FROM t1;

# Test cleanup section

--echo
--echo ***  DROP bup_db1, bup_db2 DATABASE ****
--echo

DROP DATABASE bup_db1;

DROP DATABASE bup_db2;

remove_file $MYSQLD_DATADIR/bup_objectview.bak;
remove_file $MYSQLD_DATADIR/bup_objectview1.bak;
remove_file $MYSQLD_DATADIR/bup_objectview2.bak;
remove_file $MYSQLD_DATADIR/bup_objectview3.bak;

#BUG#35249 Mysql server crash for delete operation followed by backup for Default Drivers.
