--echo #
--echo # MyISAM keycache coverage tests.
--echo #

--source include/have_debug.inc

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

CREATE TABLE t1 (c1 VARCHAR(5), c2 int) ENGINE=MyISAM;
CREATE INDEX i1 ON t1 (c1, c2);
INSERT INTO t1 VALUES ('A',1);
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;

--echo #
--echo # Positive tests.
--echo #
SELECT COUNT(*) FROM t1 WHERE c2 < 5;
LOAD INDEX INTO CACHE t1;
UPDATE t1 SET c2=2;

--echo #
--echo # Close table and clear cache.
--echo #
FLUSH TABLE t1;

--echo #
--echo # Inject error key_cache_read_block_error
--echo #
#
# I have seen the below SELECT to succeed from time to time,
# though it shall fail due to the injected error. As far as I undestand,
# the only way for this to happen is that SELECT does not use the index.
# Since the problem is random, I add an EXPLAIN here, to see if this
# does indeed happen. If it shows a result difference from time to time,
# then perhaps FLUSH TABLE t1 does not always work reliably.
# In addition to the EXPLAIN, which is here to prove the assumption,
# I add FORCE INDEX to keep the SELECT failing, which is the whole
# purpose of this test.
#
EXPLAIN SELECT COUNT(*) FROM t1 FORCE INDEX(i1) WHERE c2 < 5;
#
# Another chance for failure could be that I did not have '+' in front
# of 'd,key_cache_read_block_error'. If the test won't fail any more,
# that was the problem. I just don't understand, why this could make a
# sporadic difference.
#
SET SESSION debug='+d,key_cache_read_block_error';
--replace_regex /'.*\//'/
--error 126
SELECT COUNT(*) FROM t1 FORCE INDEX(i1) WHERE c2 < 5;
FLUSH TABLE t1;

--echo #
--echo # Inject error key_cache_insert_block_error
--echo #
SET debug='d,key_cache_insert_block_error';
LOAD INDEX INTO CACHE t1;
FLUSH TABLE t1;

--echo #
--echo # Inject error key_cache_write_block_error
--echo #
SET debug='d,key_cache_write_block_error';
--replace_regex /'.*\//'/
--error 126
UPDATE t1 SET c2=1;
FLUSH TABLE t1;

--echo #
--echo # Cleanup
--echo #
SET debug='';
DROP TABLE t1;

