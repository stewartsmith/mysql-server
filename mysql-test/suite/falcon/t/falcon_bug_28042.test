--source include/have_falcon.inc
--source include/have_partition.inc

#
# Bug #28042: Falcon Partitions: crash after a few alters
#
--echo *** Bug #28042 ***

# ----------------------------------------------------- #
# --- Initialisation                                --- #
# ----------------------------------------------------- #
let $engine = 'Falcon';
eval SET @@storage_engine = $engine;

--disable_warnings
DROP PROCEDURE IF EXISTS falcon4.pf3;
DROP DATABASE IF EXISTS falcon4;
--enable_warnings

CREATE DATABASE falcon4;
USE falcon4;
CREATE TABLE tf3 (
  s1 int,
  s2 varchar(200)
);

DELIMITER //;
CREATE PROCEDURE pf3 ()
BEGIN
  declare v int default 0;
  while v < 23
    do
    alter table tf3 partition by range (s1) (partition p4 values less than maxvalue);
    alter table tf3 remove partitioning;
    set v = v + 1;
  end while;
END//

# ----------------------------------------------------- #
# --- Test                                          --- #
# ----------------------------------------------------- #
CALL falcon4.pf3()//

# ----------------------------------------------------- #
# --- Check                                         --- #
# ----------------------------------------------------- #
SELECT count(*) FROM tf3//

# ----------------------------------------------------- #
# --- Final cleanup                                 --- #
# ----------------------------------------------------- #
DELIMITER ;//
DROP PROCEDURE falcon4.pf3;
DROP DATABASE falcon4;
